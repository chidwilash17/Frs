{% extends 'face/base.html' %}

{% block title %}Register Face - Face Recognition Attendance System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Register Your Face</h2>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Face Registration</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Please position your face clearly in the camera frame below. 
                    Make sure your face is well-lit and centered. Click "Capture & Register" 
                    to register your face for attendance marking.
                </p>
                
                {% csrf_token %}
                
                <div class="text-center mb-4">
                    <video id="video" width="320" height="240" autoplay></video>
                    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
                </div>
                
                <div class="text-center">
                    <button id="startCamera" class="btn btn-primary me-2">Start Camera</button>
                    <button id="capture" class="btn btn-success me-2" disabled>Capture & Register</button>
                    <button id="stopCamera" class="btn btn-danger" disabled>Stop Camera</button>
                </div>
                
                <div id="result" class="mt-3 text-center">
                    <div class="alert alert-info">
                        <strong>Tips for better face detection:</strong>
                        <ul class="text-start">
                            <li>Ensure good lighting on your face (avoid backlighting)</li>
                            <li>Position your face in the center of the frame</li>
                            <li>Remove sunglasses or face coverings</li>
                            <li>Face the camera directly (no extreme angles)</li>
                            <li>Keep a neutral expression</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Instructions</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>Click "Start Camera" to activate your webcam</li>
                    <li>Position your face in the frame</li>
                    <li>Ensure good lighting on your face</li>
                    <li>Click "Capture & Register" to save your face data</li>
                    <li>You'll be redirected to the attendance page after successful registration</li>
                </ol>
                <p class="text-muted">
                    Note: Your face data is securely stored and used only for attendance verification.
                </p>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Troubleshooting</h5>
            </div>
            <div class="card-body">
                <p>If face detection fails:</p>
                <ul>
                    <li>Check lighting conditions</li>
                    <li>Move closer to the camera</li>
                    <li>Try a different background</li>
                    <li>Ensure your face is fully visible</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let startButton = document.getElementById('startCamera');
    let captureButton = document.getElementById('capture');
    let stopButton = document.getElementById('stopCamera');
    let resultDiv = document.getElementById('result');
    let stream = null;
    
    startButton.addEventListener('click', async function() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            resultDiv.innerHTML = '<div class="alert alert-info">Camera started. Please position your face in the frame. Make sure your face is well-lit and centered.</div>';
            startButton.disabled = true;
            captureButton.disabled = false;
            stopButton.disabled = false;
        } catch (err) {
            resultDiv.innerHTML = `<div class="alert alert-danger">Error accessing camera: ${err.message}</div>`;
        }
    });
    
    stopButton.addEventListener('click', function() {
        if (stream) {
            const tracks = stream.getTracks();
            tracks.forEach(track => track.stop());
            video.srcObject = null;
        }
        resultDiv.innerHTML = '<div class="alert alert-info">Camera stopped.</div>';
        startButton.disabled = false;
        captureButton.disabled = true;
        stopButton.disabled = true;
    });
    
    captureButton.addEventListener('click', function() {
        // Draw the current video frame to the canvas
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Convert canvas to data URL
        const imageData = canvas.toDataURL('image/jpeg');
        
        // Send to server for processing
        resultDiv.innerHTML = '<div class="alert alert-warning">Processing face registration... Please wait.</div>';
        
        // Get CSRF token
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch('{% url "face:register_face" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: new URLSearchParams({
                'image': imageData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
                // Redirect to mark attendance page after successful registration
                setTimeout(function() {
                    window.location.href = '{% url "face:mark_attendance" %}';
                }, 2000);
            } else {
                resultDiv.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
                // Add retry button
                resultDiv.innerHTML += '<button id="retryButton" class="btn btn-primary mt-2">Try Again</button>';
                document.getElementById('retryButton').addEventListener('click', function() {
                    resultDiv.innerHTML = '<div class="alert alert-info">Please adjust your position and try capturing again.</div>';
                });
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div class="alert alert-danger">Network error: ' + error.message + '</div>';
        });
    });
</script>
{% endblock %}